% quaternion frame

rosshutdown % desligar antes
rosinit % roscore

clc;
[accx accy accz gyrox gyroy gyroz] = arq_imu(0);
tam = length(gyrox);

[accx_0 accy_0 accz_0 gyrox_0 gyroy_0 gyroz_0] = imu_calibration();

gyrox = gyrox + gyrox_0;
gyroy = gyroy + gyroy_0;
gyroz = gyroz + gyroz_0;

x = [1 0 0 0]';

for i=1:tam
   X = [x(1) -x(2) -x(3) -x(4);x(2) x(1) -x(4) x(3);x(3) x(4) x(1) -x(2);x(4) -x(3) x(2) x(1)];
    
   w = [0 gyrox(i) gyroy(i) gyroz(i)]';
       
   x_ = x + (dt/2)*X*w;
   
   x= x_;
   
   x_q(i,1) = normalize(quaternion(x(1),x(2),x(3),x(4)));
    
end
% Ros data
tftree = rostf;
tform = rosmessage('geometry_msgs/TransformStamped');
tform.ChildFrameId = 'imu';
tform.Header.FrameId = 'map';
tform.Transform.Translation.X = 0;
tform.Transform.Translation.Y = 0;
tform.Transform.Translation.Z = 0;
tform.Transform.Rotation.W = 1;
tform.Transform.Rotation.X = 0;
tform.Transform.Rotation.Y = 0;
tform.Transform.Rotation.Z = 0;

while(1)
for i = 1 : tam

    [a b c d] = parts(output(i));
    
    tform.Transform.Rotation.W = a;
    tform.Transform.Rotation.X = b;
    tform.Transform.Rotation.Y = c;
    tform.Transform.Rotation.Z = d;
    tform.Header.Stamp = rostime('now')
    sendTransform(tftree,tform)
    pause(dt)
end

end